<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: Arial, sans-serif;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: #1e1e1e;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        .titlebar {
            background-color: #2d2d2d;
            color: #ffffff;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 500;
            border-bottom: 1px solid #3e3e3e;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            flex-shrink: 0;
            position: relative;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .titlebar-text {
            flex: 1;
        }

        .keyboard-btn {
            background-color: #3e3e3e;
            color: #ffffff;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }

        .keyboard-btn:hover {
            background-color: #4e4e4e;
        }

        .keyboard-btn:active {
            background-color: #5e5e5e;
        }

        .keyboard-btn.auto-mode {
            background-color: #0066cc;
        }

        .keyboard-btn.auto-mode:hover {
            background-color: #0077ee;
        }

        .iframe-container {
            flex: 1;
            width: 100%;
            overflow: hidden;
            background-color: #282828;
            position: relative;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }

        @supports (-webkit-touch-callout: none) {
            body {
                height: 100vh;
                height: -webkit-fill-available;
            }
        }
    </style>
</head>
<body>
    <div class="titlebar">
        <div class="titlebar-text">Remote Browser</div>
        <button class="keyboard-btn" id="keyboard-toggle">⌨️ Keyboard</button>
    </div>
    <div class="iframe-container" id="iframe-container">
        <iframe 
            id="vnc-iframe"
            src="http://172.17.17.229/vnc.html?autoconnect=true&resize=remote"
            allowfullscreen>
        </iframe>
    </div>

<script>
    const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

    const keyboardBtn = document.getElementById('keyboard-toggle');
    const iframeContainer = document.getElementById('iframe-container');
    const vncIframe = document.getElementById('vnc-iframe');

    // Hide keyboard button on non-touch devices
    if (!isTouchDevice) {
        keyboardBtn.style.display = 'none';
    }

    function getNoVNCKeyboardState() {
        try {
            const btn =
                vncIframe.contentDocument.getElementById('noVNC_keyboard_button');
            if (!btn) return null;

            const pressed =
                btn.getAttribute('aria-pressed') === 'true' ||
                btn.classList.contains('noVNC_selected');

            return pressed ? 'shown' : 'hidden';
        } catch {
            return null;
        }
    }

    function setNoVNCKeyboardState(desired) {
        try {
            const current = getNoVNCKeyboardState();
            if (current && current !== desired) {
                const btn =
                    vncIframe.contentDocument.getElementById('noVNC_keyboard_button');
                if (btn) btn.click();
            }
        } catch {}
    }

    function toggleNoVNCKeyboard() {
        try {
            const btn =
                vncIframe.contentDocument.getElementById('noVNC_keyboard_button');
            if (btn) btn.click();
        } catch {}
    }

    function updateLayout() {
        const titlebarHeight =
            document.querySelector('.titlebar').offsetHeight;
        const availableHeight =
            (window.visualViewport
                ? window.visualViewport.height
                : window.innerHeight) - titlebarHeight;

        iframeContainer.style.height = `${availableHeight}px`;
        vncIframe.style.height = `${availableHeight}px`;
    }

    // --- SSE (Android / non-iOS only)
    function connectSSE() {
        const eventSource = new EventSource('/keyboard-events');

        eventSource.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                if (data.keyboard_status === 'show') {
                    setNoVNCKeyboardState('shown');
                } else if (data.keyboard_status === 'hide') {
                    setNoVNCKeyboardState('hidden');
                }
            } catch {}
        };

        eventSource.onerror = () => {
            eventSource.close();
            setTimeout(connectSSE, 5000);
        };
    }

    // --- Button = FORCE OVERRIDE (always)
    keyboardBtn.addEventListener('click', () => {
        toggleNoVNCKeyboard();
    });

    // --- Viewport handling
    if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', updateLayout);
        window.visualViewport.addEventListener('scroll', updateLayout);
    }
    window.addEventListener('resize', updateLayout);
    window.addEventListener('orientationchange', () =>
        setTimeout(updateLayout, 300)
    );

    // --- Init
    updateLayout();

    if (isTouchDevice && !isIOS) {
        connectSSE();
    }
</script>
 
</body>
</html>